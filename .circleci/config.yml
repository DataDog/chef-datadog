version: 2.1

executors:
  chefworkstation:
    docker:
      - image: chef/chefworkstation:current
  chef:
    machine:
      image: ubuntu-2004:202201-02

jobs:
  lint:
    executor: chefworkstation
    environment:
      CHEF_LICENSE: accept-no-persist
    steps:
      - checkout
      - run:
          name: Lint
          command: chef exec cookstyle --display-cop-names --extra-details

  unit:
    executor: chefworkstation
    environment:
      CHEF_LICENSE: accept-no-persist
    steps:
      - checkout
      - run:
          name: Install gems
          command: chef gem install coveralls json_spec
      - run:
          name: Unit
          command: chef exec rspec spec/

  integration:
    executor: chef
    parameters:
      chef_version:
        description: Chef version to test against
        type: string
      os:
        description: OS and version to test against
        type: string
    environment:
      CHEF_LICENSE: accept-no-persist
      CHEF_VERSION: <<parameters.chef_version>>
      KITCHEN_LOCAL_YAML: kitchen.docker.yml
    steps:
      - checkout
      - run:
          name: Install Chef
          command: |
            curl -L https://omnitruck.chef.io/install.sh |
              sudo bash -s -- -c stable -P chef-workstation
      - run:
          name: Test Kitchen
          no_output_timeout: 1h
          command: kitchen test <<parameters.os>>
      - store_artifacts:
          path: .kitchen/logs

workflows:
  build_and_test:
    jobs:
      - lint
      - unit
      - integration:
          matrix:
            parameters:
              chef_version:
                - "13"
                - "14"
                - "16"
                - "17"
              os:
                - amazonlinux-2
                - centos-7
                - centos-8
                - debian-9
                - debian-10
                - ubuntu-1804
                - ubuntu-2004
