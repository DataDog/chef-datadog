version: 2.1

executors:
  chefworkstation:
    docker:
      - image: chef/chefworkstation:current
  chef:
    machine:
      image: ubuntu-2004:202201-02

jobs:
  lint:
    executor: chefworkstation
    environment:
      CHEF_LICENSE: accept-no-persist
    steps:
      - checkout
      - run:
          name: Lint
          command: chef exec cookstyle --display-cop-names --extra-details

  unit:
    executor: chefworkstation
    environment:
      CHEF_LICENSE: accept-no-persist
    steps:
      - checkout
      - run:
          name: Install gems
          command: chef gem install coveralls json_spec rspec_junit_formatter
      - run:
          name: Unit
          # Parallelize unit tests
          # DOCS: https://circleci.com/docs/2.0/parallelism-faster-jobs/
          # EXAMPLE: https://circleci.com/developer/orbs/orb/betterdoc/ruby-build
          command: |
            TEST_FILES="$(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)"
            chef exec rspec $TEST_FILES
      - store_test_results:
          path: /tmp/chef-datadog-rspec.xml

  integration:
    executor: chef
    parameters:
      command:
        description: The kitchen test command to run, w/ Chef version specified via env var $CHEF_VERSION
        type: string
    environment:
      CHEF_LICENSE: accept-no-persist
      KITCHEN_LOCAL_YAML: kitchen.docker.yml
    steps:
      - checkout
      - run:
          name: Install Chef
          command: |
            curl -L https://omnitruck.chef.io/install.sh |
              sudo bash -s -- -c stable -P chef-workstation
      - run:
          name: Test Kitchen
          no_output_timeout: 1h
          command: <<parameters.command>>
      - store_artifacts:
          path: .kitchen/logs

workflows:
  build_and_test:
    jobs:
      - lint
      - unit
      - integration:
          matrix:
            parameters:
              command:
                - CHEF_VERSION=14 kitchen test dd-agent-handler5-centos-6
                - CHEF_VERSION=14 kitchen test dd-agent-handler5-centos-7
                - CHEF_VERSION=14 kitchen test dd-agent-handler5-debian-8
                - CHEF_VERSION=16 kitchen test dd-agent-handler5-rocky-8
                - CHEF_VERSION=14 kitchen test dd-agent-handler5-ubuntu-1404
                - CHEF_VERSION=14 kitchen test dd-agent-handler6-centos-6
                - CHEF_VERSION=14 kitchen test dd-agent-handler6-centos-7
                - CHEF_VERSION=16 kitchen test dd-agent-handler6-rocky-8
                - CHEF_VERSION=14 kitchen test dd-agent-handler7-centos-6
                - CHEF_VERSION=14 kitchen test dd-agent-handler7-centos-7
                - CHEF_VERSION=16 kitchen test dd-agent-handler7-rocky-8
