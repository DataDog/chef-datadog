<%
# OPTIONS REMOVED IN AGENT 6:
# - check_freq
# - use_mount
# - developer_mode
# - dogstreams
# - autorestart
# - custom_emitters
# - graphite
# - dogstatsd_target
# - dogstatsd_interval
# - dogstatsd_normalize
# - legacy_integrations

# TODO: options not supported yet:
# - agent_checks_interval
# - Autodiscovery (aka Service Discovery) related options
# - statsd_forward_host
# - statsd_forward_port
# - statsd_metric_namespace
# - enable_trace_agent: always enabled
# - all trace-related options are written to an INI file

def string_list_to_array(string_list)
  # return an array from a comma-separated list in a string
  string_list.split(',').map{ |elem| elem.strip }
end

## Normalize complex config values for agent6 format ##
if node['datadog']['tags'].respond_to?(:each_pair)
  tags = node['datadog']['tags'].reject{ |_k,v| v.empty? }.map{ |k,v| "#{k.strip}:#{v.strip}" }
else
  tags = string_list_to_array(node['datadog']['tags'])
end

# TODO: support the more complete proxy settings that the agent6 supports
http_proxy = nil
if node['datadog']['web_proxy']['host']
  host = node['datadog']['web_proxy']['host']
  port = node['datadog']['web_proxy']['port']
  user = node['datadog']['web_proxy']['user']
  password = node['datadog']['web_proxy']['password']
  scheme = ""

  unless host.start_with?('http://') or host.start_with?('https://')
    scheme = 'http://'
  end

  http_proxy = host
  if port
    http_proxy += ":#{port}"
  end
  if user
    if password
      http_proxy = "#{user}:#{port}@#{http_proxy}"
    else
      http_proxy = "#{user}@#{http_proxy}"
    end
  end

  http_proxy = scheme + http_proxy
end

# In the default case we will start and run with only container collection.
process_agent_enabled = 'false'

if node['datadog']['enable_process_agent'].is_a?(TrueClass)
  # Collect processes if enabled.
  process_agent_enabled = 'true'
elsif node['datadog']['enable_process_agent'].is_a?(FalseClass)
  # Disable the Agent altogether if false.
  process_agent_enabled = 'disabled'
end

## Populate agent_config ##
agent_config = @extra_config.merge({
  api_key: @api_key,
  dd_url: node['datadog']['url'],
  hostname: node['datadog']['hostname'],
  additional_endpoints: @additional_endpoints,
  listen_port: node['datadog']['agent_port'],
  bind_host: node['datadog']['bind_host'],
  skip_ssl_validation: node['datadog']['web_proxy']['skip_ssl_validation'],
  tags: tags,
  create_dd_check_tags: node['datadog']['create_dd_check_tags'],
  collect_ec2_tags: node['datadog']['collect_ec2_tags'],
  non_local_traffic: node['datadog']['non_local_traffic'],
  histogram_aggregates: string_list_to_array(node['datadog']['histogram_aggregates']),
  histogram_percentiles: string_list_to_array(node['datadog']['histogram_percentiles']),  # TODO: check that the value works with agent6
  use_dogstatsd: node['datadog']['dogstatsd'],
  log_level: node['datadog']['log_level'],  # TODO: make sure it's a seelog-compatible log level
  log_file: ::File.join(node['datadog']['log_file_directory'], "agent.log"),

  # log agent options
  log_enabled: node['datadog']['enable_logs_agent'],

  # process agent options
  process_config: {
    enabled: process_agent_enabled,
    log_file: node['datadog']['process_agent']['log_file'],
    intervals: {
      container: node['datadog']['process_agent']['container_interval'],
      container_realtime: node['datadog']['process_agent']['rtcontainer_interval'],
      process: node['datadog']['process_agent']['rtcontainer_interval'],
      process_realtime: node['datadog']['process_agent']['rtprocess_interval'],
    },
    blacklist_patterns: node['datadog']['process_agent']['blacklist'],
    process_dd_url: node['datadog']['process_agent']['url']
  }
})

if node['datadog']['use_v2_api']
  agent_config['use_v2_api'] = node['datadog']['use_v2_api']
end

if node['datadog']['syslog']['active']
  agent_config['log_to_syslog'] = true
  # TODO: double check the udp settings work with agent6
  if node['datadog']['syslog']['udp']
    agent_config['syslog_uri']  = "#{node['datadog']['syslog']['host']}:#{node['datadog']['syslog']['port']}"
  end
end

# Set proxy options
if !http_proxy.nil?
  agent_config['proxy'] = {
    http: http_proxy,
    https: http_proxy
  }
end

# Remove nil values
agent_config.reject!{ |k,v| v.nil? }
agent_config[:process_config][:intervals].reject!{ |k,v| v.nil? }

-%>
# Generated by Chef, local modifications will be overwritten

<%= JSON.parse(agent_config.to_json).to_yaml %>
